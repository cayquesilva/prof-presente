// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ORGANIZER
  CHECKIN_COORDINATOR
  TEACHER
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  CANCELLED
  REJECTED
}

model User {
  id          String    @id @default(uuid())
  name        String
  email       String    @unique
  password    String
  cpf         String?   @unique
  birthDate   DateTime
  phone       String?
  address     String?
  photoUrl    String?
  role        UserRole  @default(TEACHER)
  workplaceId String?   @map("workplace_id")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relacionamentos
  enrollments   Enrollment[]
  userAwards    UserAward[]
  userBadge     UserBadge?
  workplace     Workplace? @relation(fields: [workplaceId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([role])
  @@index([workplaceId])
  @@index([createdAt])
  @@map("users")
}

model Event {
  id           String    @id @default(uuid())
  title        String
  description  String
  startDate    DateTime
  endDate      DateTime
  location     String
  maxAttendees Int?
  imageUrl     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

   // NOVOS CAMPOS: Para o crach√° impresso personalizado
  badgeTemplateUrl    String?   @map("badge_template_url")
  badgeTemplateConfig Json?     @map("badge_template_config")

  // Relacionamentos
  enrollments Enrollment[]

  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
  @@map("events")
}

model Enrollment {
  id             String           @id @default(uuid())
  userId         String
  eventId        String
  enrollmentDate DateTime         @default(now())
  status         EnrollmentStatus @default(APPROVED)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relacionamentos
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  courseEvaluation CourseEvaluation?

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([enrollmentDate])
  @@map("enrollments")
}

model Award {
  id          String   @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  criteria    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  userAwards UserAward[]

  @@index([createdAt])
  @@map("awards")
}

model UserAward {
  id        String   @id @default(uuid())
  userId    String
  awardId   String
  awardedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  award Award @relation(fields: [awardId], references: [id], onDelete: Cascade)

  @@unique([userId, awardId])
  @@index([userId])
  @@index([awardId])
  @@index([awardedAt])
  @@map("user_awards")
}

model CourseEvaluation {
  id           String   @id @default(uuid())
  enrollmentId String   @unique
  rating       Int      @default(1) // 1 a 5 estrelas
  comment      String?
  evaluatedAt  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([rating])
  @@index([evaluatedAt])
  @@index([createdAt])
  @@map("course_evaluations")
}

model UserBadge {
  id             String    @id @default(uuid())
  userId         String    @unique
  badgeCode      String    @unique
  qrCodeUrl      String
  badgeImageUrl  String
  issuedAt       DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relacionamentos
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userCheckins   UserCheckin[]

  @@index([badgeCode])
  @@index([issuedAt])
  @@index([createdAt])
  @@map("user_badges")
}

model UserCheckin {
  id            String      @id @default(uuid())
  userBadgeId   String
  eventId       String
  checkinTime   DateTime    @default(now())
  location      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relacionamentos
  userBadge UserBadge @relation(fields: [userBadgeId], references: [id], onDelete: Cascade)

  @@index([userBadgeId])
  @@index([eventId])
  @@index([checkinTime])
  @@index([createdAt])
  @@map("user_checkins")
}

model Workplace {
  id          String   @id @default(uuid())
  name        String
  description String?
  city        String
  state       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  users User[]

  @@index([name])
  @@index([city])
  @@index([state])
  @@map("workplaces")
}
